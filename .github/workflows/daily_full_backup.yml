name: Daily Full Backup

on:
  schedule:
    # Körs klockan 02:00 varje natt (UTC)
    - cron: '0 2 * * *'
  workflow_dispatch: # Knapp för att köra manuellt

permissions:
  contents: write

jobs:
  backup-job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Perform Backup & Cleanup
        run: |
          # 1. Sätt datumvariabel (t.ex. 2025-05-20)
          TODAY=$(date +'%Y-%m-%d')
          BACKUP_DIR="backups/$TODAY"
          
          # 2. Skapa dagens mapp
          mkdir -p "$BACKUP_DIR"
          
          # 3. Kopiera filer (om de finns)
          [ -f sources.py ] && cp sources.py "$BACKUP_DIR/"
          [ -f generator.py ] && cp generator.py "$BACKUP_DIR/"
          [ -f template.html ] && cp template.html "$BACKUP_DIR/"
          [ -f admin.html ] && cp admin.html "$BACKUP_DIR/"
          
          echo "Backup created in: $BACKUP_DIR"

          # 4. Rensa mappar äldre än 10 dagar
          # Detta kommando letar i 'backups', hittar mappar, sorterar dem på tid, 
          # och tar bort alla utom de 10 senaste.
          cd backups
          if [ -d "." ]; then
            ls -1t | tail -n +11 | xargs -I {} rm -rf "{}" || true
          fi
          echo "Cleanup complete (kept last 10 backups)."

      - name: Commit and Push
        run: |
          git config --global user.name "Backup Bot"
          git config --global user.email "bot@noreply.github.com"
          
          git add backups/
          
          # Commit endast om det finns ändringar
          git commit -m "Daily Backup: $TODAY" || echo "No changes to commit"
          
          git push
