<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPECULA ADMIN // V22.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050505; --surface: #121212; --border: #333; --accent: #00f0ff; --text: #fff; --success: #00ff88; --warning: #ffaa00; --fail: #ff4444; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER */
        .top-bar { height: 80px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: rgba(0,0,0,0.95); z-index: 100; flex-shrink: 0; position: relative; }
        .brand-group { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; }
        .brand-row { display: flex; align-items: center; gap: 10px; }
        .logo-img { height: 30px; cursor: pointer; transition: transform 0.2s; }
        .logo-img:hover { transform: scale(1.1); filter: drop-shadow(0 0 5px var(--accent)); }
        .brand-text { font-family: 'Space Grotesk'; font-weight: 700; font-size: 1.2rem; letter-spacing: 1px; color: #fff; text-decoration: none; transition: color 0.2s; }
        .brand-text:hover { color: var(--accent); text-shadow: 0 0 10px var(--accent); }
        .brand-text span { color: var(--accent); }
        .version-tag { font-size: 0.65rem; color: #666; font-family: monospace; letter-spacing: 1px; margin-left: 40px; }

        /* CENTER STAGE */
        .center-stage { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); display: flex; align-items: center; gap: 15px; }
        .cyber-btn { background: rgba(0, 0, 0, 0.6); border: 1px solid var(--accent); color: var(--accent); padding: 0 30px; height: 44px; font-family: 'Space Grotesk', monospace; font-size: 0.9rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; position: relative; overflow: hidden; transition: all 0.3s ease; box-shadow: 0 0 10px rgba(0, 240, 255, 0.1); display: flex; align-items: center; justify-content: center; border-radius: 4px; }
        .cyber-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(0, 240, 255, 0.2), transparent); transition: 0.5s; }
        .cyber-btn:hover { background: rgba(0, 240, 255, 0.1); box-shadow: 0 0 20px rgba(0, 240, 255, 0.4); text-shadow: 0 0 8px var(--accent); }
        .cyber-btn:hover::before { left: 100%; }
        .cyber-btn.syncing { border-color: var(--warning); color: var(--warning); animation: pulse-border 1.5s infinite; cursor: default; }
        .cyber-btn.success { border-color: var(--success); color: var(--success); background: rgba(0, 255, 136, 0.05); box-shadow: 0 0 20px rgba(0, 255, 136, 0.2); }
        @keyframes pulse-border { 0% { box-shadow: 0 0 5px var(--warning); } 50% { box-shadow: 0 0 20px var(--warning); } 100% { box-shadow: 0 0 5px var(--warning); } }
        .sync-info { font-family: monospace; font-size: 0.75rem; color: #666; opacity: 0; transition: opacity 0.5s; white-space: nowrap; }
        .sync-info.visible { opacity: 1; }

        /* ACTIONS */
        .actions { display: flex; align-items: center; gap: 10px; justify-content: flex-end; }
        button.tool-btn { font-family: 'Space Grotesk'; font-weight: 700; cursor: pointer; transition: 0.2s; border-radius: 6px; border: 1px solid #444; background: #222; color: #fff; padding: 10px 16px; font-size: 0.8rem; display: flex; align-items: center; gap: 6px; }
        button.tool-btn:hover { border-color: #fff; background: #333; }
        .btn-save { background: var(--accent) !important; color: #000 !important; border-color: var(--accent) !important; }
        .btn-save:hover { background: #fff !important; }
        .btn-logout { border-color: #ff4444 !important; color: #ff4444 !important; background: transparent !important; }
        .btn-logout:hover { background: #ff4444 !important; color: #fff !important; }

        /* NAV */
        .nav-container { display: flex; align-items: center; padding: 10px 20px; background: #0a0a0a; border-bottom: 1px solid var(--border); gap: 10px; z-index: 90; flex-wrap: wrap; min-height: 50px; flex-shrink: 0; }
        .nav-item { position: relative; padding: 8px 12px; cursor: pointer; font-family: 'Space Grotesk'; font-weight: 700; font-size: 0.8rem; color: #666; text-transform: uppercase; display: flex; align-items: center; gap: 5px; border-radius: 4px; background: #111; border: 1px solid transparent; }
        .nav-item:hover { color: #fff; background: #1a1a1a; border-color: #333; }
        .nav-item.active { color: #000; background: var(--accent); border-color: var(--accent); }
        .nav-item::after { content: ''; position: absolute; left: 0; bottom: -15px; width: 100%; height: 20px; background: transparent; z-index: 205; }
        .dropdown { position: absolute; top: 100%; left: 0; background: #111; border: 1px solid #333; border-radius: 6px; padding: 5px; min-width: 180px; display: none; flex-direction: column; z-index: 200; box-shadow: 0 10px 30px rgba(0,0,0,0.8); margin-top: 5px; }
        .nav-item:hover .dropdown, .dropdown:hover { display: flex; }
        .drop-item { padding: 8px 12px; color: #888; font-size: 0.8rem; cursor: pointer; display: flex; justify-content: space-between; }
        .drop-item:hover { background: #222; color: #fff; }
        .drop-item.selected { color: var(--accent); }

        /* GRID */
        .main-view { flex-grow: 1; padding: 30px; overflow-y: auto; background: radial-gradient(circle at 50% 20%, #111 0%, #050505 60%); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .card { background: #141414; border: 1px solid #2a2a2a; border-radius: 8px; padding: 15px; position: relative; display: flex; flex-direction: column; gap: 10px; }
        .card:hover { border-color: #555; background: #1a1a1a; transform: translateY(-2px); transition: 0.2s; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 5px; padding-right: 30px; }
        .favicon-wrap { display: flex; align-items: center; gap: 10px; width: 100%; }
        .favicon { width: 24px; height: 24px; border-radius: 4px; object-fit: contain; background: #000; }
        .edit-name { background: transparent; border: none; border-bottom: 1px solid #333; color: #fff; font-family: 'Space Grotesk'; font-weight: 700; font-size: 1rem; width: 100%; padding: 4px 0; }
        .edit-name:focus { border-color: var(--accent); outline: none; }
        
        /* CARD IMAGE PREVIEW */
        .card-image { width: 100%; height: 160px; background: #080808; border-radius: 4px; margin-bottom: 5px; position: relative; overflow: hidden; display:flex; align-items:center; justify-content:center; border:1px solid #333; }
        .card-image span { color: #555; font-size: 0.8rem; font-family: monospace; z-index: 2; position: relative; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 4px; }
        .card-image img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; transition: 0.3s; }
        .card:hover .card-image img { transform: scale(1.05); }
        .live-tag { position: absolute; top: 5px; right: 5px; background: var(--success); color: #000; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; z-index: 10; opacity: 0.8; }
        .sim-tag { position: absolute; top: 5px; right: 5px; background: var(--warning); color: #000; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; z-index: 10; opacity: 0.8; }

        .status-dot { position: absolute; top: 15px; right: 45px; width: 10px; height: 10px; border-radius: 50%; background: #333; transition: 0.3s; cursor: pointer; border: 1px solid #000; }
        .status-dot:hover { transform: scale(1.5); border-color: #fff; }
        .status-ok { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-warn { background: var(--warning); box-shadow: 0 0 8px var(--warning); }
        .status-err { background: var(--fail); box-shadow: 0 0 8px var(--fail); }

        .btn-del-corner { position: absolute; top: 10px; right: 10px; background: transparent; color: #444; border: 1px solid #333; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-weight: bold; cursor: pointer; padding: 0; transition:0.2s; }
        .btn-del-corner:hover { background: #330000; color: #ff4444; border-color: #ff4444; }

        .btn-link-action { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; background: #222; border: 1px solid #444; color: #888; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .btn-link-action:hover { background: #330000; color: #ff4444; border-color: #ff4444; }

        .url-block { display: flex; flex-direction: column; gap: 5px; }
        .url-actions { display: flex; justify-content: space-between; align-items: center; }
        .edit-url { background: #000; border: 1px solid #333; color: #bbb; font-family: monospace; font-size: 0.75rem; width: 100%; padding: 8px; border-radius: 4px; margin-top: 5px; }
        .edit-url:focus { border-color: var(--accent); color: #fff; outline: none; }
        .btn-analyze { background: #222; color: var(--accent); border: 1px solid #333; font-size: 0.7rem; padding: 4px 8px; cursor: pointer; border-radius: 4px; }
        .btn-analyze:hover { border-color: var(--accent); background: rgba(0, 240, 255, 0.1); }
        .card-footer { margin-top: 10px; border-top: 1px solid #222; padding-top: 10px; display: flex; gap: 10px; }
        .move-select { background: #000; color: #aaa; border: 1px solid #333; padding: 6px; border-radius: 4px; width: 100%; font-size: 0.75rem; cursor: pointer; }

        /* MODALS */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .overlay.open { display: flex; }
        .modal-window { background: #111; border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; padding: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); width: 90%; max-width: 800px; max-height: 90vh; }
        
        .close-modal-btn { background: transparent; border: none; font-size: 1.5rem; cursor: pointer; color: #ff4444; transition: 0.2s; }
        .close-modal-btn:hover { color: #fff; transform: scale(1.1); }
        
        .login-box { width: 400px; text-align: left; gap: 15px; }
        .login-label { font-size: 0.8rem; color: #888; margin-top: 10px; margin-bottom: 2px; text-transform: uppercase; font-weight: bold; }
        .login-input { width: 100%; padding: 10px; background: #000; border: 1px solid #333; color: #fff; font-family: monospace; border-radius: 4px; box-sizing: border-box; }
        .btn-login { width: 100%; padding: 15px; background: var(--accent); color: #000; font-weight: bold; border: none; cursor: pointer; border-radius: 6px; margin-top: 20px; }
        
        .dump-box { width: 600px; height: 600px; max-width: 90vw; max-height: 90vh; }
        .drop-zone { height: 100%; border: 3px dashed #444; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; transition: 0.3s; cursor: pointer; background: #161616; }
        .drop-zone:hover { border-color: var(--accent); color: var(--accent); }
        
        .logic-list { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; overflow-y: auto; max-height: 60vh; }
        .logic-item { background: #1a1a1a; padding: 12px; border-radius: 6px; border-left: 4px solid #333; display: flex; flex-direction: column; gap: 5px; }
        .logic-item.success { border-left-color: var(--success); background: rgba(0, 255, 136, 0.05); }
        .strat-preview { width: 80px; height: 50px; object-fit: cover; border-radius: 4px; border: 1px solid #444; background: #000; }
        .logic-content { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        .btn-apply { background: var(--success); color: #000; border: none; padding: 5px 15px; font-size: 0.75rem; cursor: pointer; border-radius: 4px; font-weight: bold; white-space: nowrap; }
        .btn-fix { background: var(--warning); color: #000; border: none; font-size: 0.7rem; padding: 4px 8px; animation: pulse 2s infinite; display: none; }
        
        .fail-options { display: flex; gap: 10px; margin-top: 20px; }
        .btn-fail-action { flex: 1; padding: 15px; background: #222; border: 1px solid #333; color: #ccc; border-radius: 6px; }
        .btn-fail-action:hover { border-color: #fff; background: #333; color: #fff; }

        .editor-window { max-width: 1000px; height: 85vh; }
        .code-area { flex-grow: 1; background: var(--code-bg); color: #ccc; border: 1px solid var(--border); font-family: monospace; padding: 15px; font-size: 0.9rem; resize: none; border-radius: 6px; white-space: pre-wrap; overflow-y: auto; margin: 15px 0; }
        .btn-clear { background: #330000; border: 1px solid #ff4444; color: #ff4444; padding: 10px 20px; }
        
        /* FILE SELECT (WHITE TEXT) */
        .btn-file-select { width: 100%; margin-top: 10px; padding: 15px; background: #222; color: #fff !important; border: 1px solid #444; border-radius: 6px; font-family: 'Space Grotesk', sans-serif; font-size: 1rem; cursor: pointer; transition: 0.2s; }
        .btn-file-select:hover { background: #333; border-color: #fff; }
        .btn-cancel { width: 100%; margin-top: 15px; border: none; background: transparent; color: #fff; font-size: 0.9rem; cursor: pointer; opacity: 0.6; }
        .btn-cancel:hover { opacity: 1; }

        .add-bar { height: 70px; border-top: 1px solid var(--border); background: #080808; display: flex; align-items: center; padding: 0 30px; gap: 10px; flex-shrink: 0; }
        .add-input { background: #111; border: 1px solid #333; color: white; padding: 12px; border-radius: 4px; font-family: 'Inter'; font-size: 0.9rem; }
        .toast { position: fixed; top: 90px; left: 50%; transform: translateX(-50%); background: #1a1a1a; border: 1px solid var(--success); color: var(--success); padding: 12px 30px; border-radius: 30px; opacity: 0; pointer-events: none; transition: 0.3s; font-weight: bold; z-index: 999; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .toast.show { opacity: 1; top: 110px; }
        .status-box { background: #111; padding: 10px; border: 1px solid #333; border-radius: 4px; font-family: monospace; font-size: 0.8rem; margin-bottom: 10px; color: #888; }
        @keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }
    </style>
</head>
<body>

    <input type="file" id="fileDumpInput" style="display:none" onchange="handleFileDump(this)">

    <!-- LOGIN -->
    <div class="overlay open" id="loginModal" style="z-index:9999; background:#000;">
        <div class="modal-window login-box">
            <h2 style="color:var(--accent); text-align:center;">SPECULA CONFIG</h2>
            <div class="login-label">GITHUB USERNAME</div>
            <input type="text" id="userInput" class="login-input" value="specula">
            <div class="login-label">REPOSITORY NAME</div>
            <input type="text" id="repoInput" class="login-input" value="specula">
            <div class="login-label">PERSONAL ACCESS TOKEN</div>
            <input type="password" id="tokenInput" class="login-input" placeholder="ghp_...">
            <button class="btn-login" onclick="performLogin()">UNLOCK SYSTEM</button>
        </div>
    </div>

    <!-- MAIN UI -->
    <div class="top-bar">
        <div class="brand-group">
            <div class="brand-row">
                <div class="logo-safe-wrapper" style="width:30px; height:30px; overflow:hidden;">
                    <img src="icon.png" width="30" height="30" class="logo-img" onclick="location.reload()" title="Reload Admin">
                </div>
                <a href="https://specula-news.netlify.app/" target="_blank" class="brand-text">SPECULA <span>ADMIN</span></a>
            </div>
            <div class="version-tag">V22.0</div>
        </div>
        
        <!-- CENTER STAGE -->
        <div class="center-stage">
            <button id="deployCore" class="cyber-btn" onclick="deployLive()">DEPLOY / SYNC</button>
            <div id="syncInfo" class="sync-info"></div>
        </div>

        <!-- RIGHT ACTIONS -->
        <div class="actions">
            <button class="tool-btn" onclick="openDumpModal()">üìÇ DUMP</button>
            <button class="tool-btn" onclick="openSelector('html')">üìù HTML</button>
            <button class="tool-btn" onclick="openSelector('py')">‚öôÔ∏è PY</button>
            <button class="tool-btn btn-save" onclick="saveToGitHubSafe()">üíæ SAVE</button>
            <button class="tool-btn btn-logout" onclick="logout()">LOGOUT</button>
        </div>
    </div>

    <div class="nav-container" id="navBar"></div>

    <div class="main-view">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
            <div id="folderTitle" style="font-family:'Space Grotesk'; font-size:1.5rem; font-weight:bold;">LOCKED</div>
            <div id="countBadge" style="background:#222; padding:5px 10px; border-radius:4px; font-size:0.8rem; color:#888;">0 Sources</div>
        </div>
        <div class="grid" id="grid"></div>
    </div>

    <!-- OVERRIDE MODAL (FIXED) -->
    <div class="overlay" id="overrideModal">
        <div class="modal-window login-box">
            <h3 style="color:var(--warning); text-align:center;">MANUAL IMAGE OVERRIDE</h3>
            <p style="font-size:0.8rem; color:#888;">Paste a direct image URL (jpg/png) to force this image.</p>
            <input type="text" id="overrideInput" class="login-input" placeholder="https://...">
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-fail-action" onclick="closeModal('overrideModal')">Cancel</button>
                <button class="btn-login" style="margin:0;" onclick="applyManualOverride()">SET IMAGE</button>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="overlay" id="dumpModal"><div class="modal-window dump-box"><div style="display:flex; justify-content:space-between; margin-bottom:10px;"><h3 style="margin:0;">UPLOAD FILE</h3><button onclick="closeModal('dumpModal')" class="close-modal-btn">√ó</button></div><div id="dropZone" class="drop-zone" onclick="document.getElementById('fileInputHidden').click()"><div style="font-size:4rem; margin-bottom:20px;">üìÇ</div><h3 style="margin:0;">DROP FILE HERE</h3><p>or click to browse</p><input type="file" id="fileInputHidden" style="display:none" onchange="handleFileSelect(this.files)"></div></div></div>
    <div class="overlay" id="testerModal"><div class="modal-window tester-window"><div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; padding-bottom:10px;"><div style="font-weight:bold; font-size:1.2rem;">‚ö° VISUAL LOGIC PROBE</div><button class="close-modal-btn" onclick="closeModal('testerModal')">√ó</button></div><div id="statusLog" class="status-box">Ready...</div><div id="logicResults" class="logic-list"></div></div></div>
    <div class="overlay" id="failModal"><div class="modal-window" style="max-width:500px; text-align:center;"><div style="font-weight:bold; font-size:1.2rem; color:var(--warning);">‚ö†Ô∏è SCAN FAILED</div><p style="color:#aaa; margin:15px 0;">I couldn't find an obvious RSS feed on this URL.</p><div class="fail-options"><button class="btn-fail-action" onclick="forceAddSource()">Force Add<br><span style="font-size:0.7em; color:#666;">(Add as is)</span></button><button class="btn-fail-action" onclick="searchGoogleForRSS()">Search Google<br><span style="font-size:0.7em; color:#666;">(Find RSS)</span></button><button class="btn-fail-action" onclick="closeModal('failModal')">Cancel</button></div></div></div>
    <div class="overlay" id="editorModal"><div class="modal-window editor-window"><div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:10px;"><div id="editorTitle" style="font-weight:bold;">EDIT</div><button onclick="closeModal('editorModal')" class="close-modal-btn">√ó</button></div><textarea id="codeContent" class="code-area" spellcheck="false"></textarea><div style="display:flex; justify-content:space-between; margin-top:15px;"><button class="btn-clear" onclick="clearEditor()">üóëÔ∏è CLEAR ALL</button><div style="display:flex; gap:10px;"><button onclick="closeModal('editorModal')" style="background:#333; border:none; color:white;">Cancel</button><button class="btn-save" onclick="saveFileContent()">üíæ SAVE & UPLOAD</button></div></div></div></div>
    <div class="overlay" id="selectorModal"><div class="modal-window" style="width:300px; text-align:center;"><h3>SELECT FILE</h3><div id="selectorButtons" style="display:flex; gap:10px; justify-content:center; flex-wrap:wrap;"></div><button class="btn-cancel" onclick="closeModal('selectorModal')">Cancel</button></div></div>

    <div class="add-bar">
        <input type="text" id="urlInput" class="add-input" placeholder="Paste URL (YouTube or Website)..." style="flex-grow: 2;" oninput="preCheckUrl()">
        <input type="text" id="nameInput" class="add-input" placeholder="Name (Optional)..." style="flex-grow: 1;">
        <button class="actions btn-save" style="border:none; padding:12px 24px; cursor:pointer;" onclick="handleAddClick()">+ ADD</button>
    </div>

    <div id="toast" class="toast">Action Saved</div>

    <script>
        const FOLDER_CONFIG = { 'GLOBAL_WEB': { label: 'NEWS: GLOBAL', cat: 'geopolitics', type: 'web', tag: 'global' }, 'MEDIA_GLOBAL': { label: 'MEDIA: Global', cat: 'geopolitics', type: 'video', tag: 'global' }, 'MEDIA_CHINA': { label: 'MEDIA: China', cat: 'geopolitics', type: 'video', tag: 'china' }, 'MEDIA_USA': { label: 'MEDIA: USA', cat: 'geopolitics', type: 'video', tag: 'usa' }, 'MEDIA_INDIA': { label: 'MEDIA: India', cat: 'geopolitics', type: 'video', tag: 'india' }, 'YT_GEO': { label: 'YT: Geo', cat: 'youtubers', type: 'video', tag: 'geo' }, 'YT_TECH': { label: 'YT: Tech', cat: 'youtubers', type: 'video', tag: 'tech' }, 'YT_ENERGY': { label: 'YT: Energy', cat: 'youtubers', type: 'video', tag: 'energy' }, 'YT_EV': { label: 'YT: EV', cat: 'youtubers', type: 'video', tag: 'ev' }, 'YT_GAME': { label: 'YT: Gaming', cat: 'youtubers', type: 'video', tag: 'gaming' }, 'GAME_WEB': { label: 'GAME: News', cat: 'gaming', type: 'web', tag: null }, 'GAME_EWC': { label: 'GAME: Video', cat: 'gaming', type: 'video', tag: null }, 'TOPIC_TECH': { label: 'TOPIC: Tech', cat: 'tech', type: 'web', tag: null }, 'TOPIC_ENERGY': { label: 'TOPIC: Energy', cat: 'energy', type: 'web', tag: null }, 'TOPIC_EV': { label: 'TOPIC: EV', cat: 'ev', type: 'web', tag: null }, 'TOPIC_SCI': { label: 'TOPIC: Science', cat: 'science', type: null, tag: null }, 'TOPIC_CONST': { label: 'TOPIC: Constr', cat: 'construction', type: null, tag: null }, 'ECONOMY': { label: 'ECONOMY', cat: 'economy', type: null, tag: null }, 'GEO_SWE': { label: 'GEO: Sweden', cat: 'geopolitics', type: 'web', tag: 'sweden' }, 'GEO_EU': { label: 'GEO: EU', cat: 'geopolitics', type: 'video', tag: 'eu' } };
        const MENU = [ { id: 'GLOBAL_WEB', label: 'ALL NEWS' }, { label: 'MEDIA', subs: ['MEDIA_GLOBAL', 'MEDIA_CHINA', 'MEDIA_USA', 'MEDIA_INDIA'] }, { label: 'YOUTUBERS', subs: ['YT_GEO', 'YT_TECH', 'YT_ENERGY', 'YT_EV', 'YT_GAME'] }, { label: 'GAMING', subs: ['GAME_WEB', 'GAME_EWC'] }, { label: 'TOPICS', subs: ['TOPIC_TECH', 'TOPIC_ENERGY', 'TOPIC_EV', 'TOPIC_SCI', 'TOPIC_CONST', 'ECONOMY'] }, { label: 'GEOPOLITICS', subs: ['GEO_SWE', 'GEO_EU'] } ];
        
        let sourceData = {}; let newsMap = {}; 
        let rawHeader = ""; let rawFooter = ""; let currentSha = ""; let activeFolder = 'GLOBAL_WEB';
        let currentFileSha = ""; let currentFileName = ""; let deployInterval = null;
        let pendingAddUrl = ""; let pendingAddName = "";
        let activeAnalyzerIndex = -1;
        let lastSyncTime = null;

        window.onload = function() { 
            for(let key in FOLDER_CONFIG) sourceData[key] = []; 
            const savedToken = localStorage.getItem("gh_token");
            const savedUser = localStorage.getItem("gh_user");
            const savedRepo = localStorage.getItem("gh_repo");
            if (savedToken && savedUser && savedRepo) { 
                document.getElementById('loginModal').classList.remove('open'); 
                fetchSources(savedUser, savedRepo, savedToken);
            }
            setupDropZone();
            setInterval(updateTimeAgo, 60000);
        };

        function updateStatus(state, msg) {
            const btn = document.getElementById('deployCore');
            const info = document.getElementById('syncInfo');
            btn.className = 'cyber-btn';
            btn.style.cursor = 'pointer';
            if(state === 'syncing') { btn.classList.add('syncing'); btn.innerText = msg; info.className = 'sync-info'; btn.style.cursor = 'default'; } 
            else if (state === 'success') { btn.classList.add('success'); btn.innerText = 'COMPLETE'; setTimeout(() => { btn.className = 'cyber-btn'; btn.innerText = 'DEPLOY / SYNC'; info.className = 'sync-info visible success'; updateTimeAgo(); }, 2000); } 
            else if (state === 'error') { btn.innerText = 'FAILED - RETRY'; btn.style.borderColor = 'var(--fail)'; btn.style.color = 'var(--fail)'; } 
            else { btn.innerText = 'DEPLOY / SYNC'; }
        }

        function updateTimeAgo() {
            if(!lastSyncTime) return;
            const diff = Math.floor((Date.now() - lastSyncTime) / 60000);
            const timeStr = new Date(lastSyncTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const info = document.getElementById('syncInfo');
            info.innerText = `LAST SYNC: ${timeStr} (${diff}m ago)`;
            info.classList.add('visible');
        }

        async function fetchSources(u,r,t) { 
            const user = u || localStorage.getItem("gh_user"); const repo = r || localStorage.getItem("gh_repo"); const token = t || localStorage.getItem("gh_token");
            try { 
                const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/sources.py`, { headers: { 'Authorization': `token ${token}` } }); 
                if(!res.ok) throw new Error("Auth Failed"); 
                const data = await res.json(); 
                currentSha = data.sha; 
                const text = new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0))); 
                parsePython(text); 

                try {
                    const res2 = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/news.json`, { headers: { 'Authorization': `token ${token}` } });
                    const data2 = await res2.json();
                    const text2 = new TextDecoder().decode(Uint8Array.from(atob(data2.content), c => c.charCodeAt(0))); 
                    const articles = JSON.parse(text2);
                    newsMap = {};
                    articles.forEach(a => { 
                        if(a.images && a.images.length > 0) { 
                            if(a.source) newsMap[a.source.toLowerCase().trim()] = a.images[0]; 
                            if(a.feed_url) newsMap[a.feed_url] = a.images[0]; 
                            const rough = a.feed_url ? a.feed_url.replace(/\/$/, "") : "";
                            if(rough) newsMap[rough] = a.images[0];
                        } 
                    });
                } catch(e) { console.log("No news.json found"); }

                renderNav(); renderGrid(); showToast("System Ready");
                if(!lastSyncTime) updateStatus('', 'DEPLOY / SYNC');
            } catch(e) { alert(e.message); if(e.message.includes("Auth")) logout(); } 
        }

        async function fetchProxy(url) {
             const target = url + (url.includes('?') ? '&' : '?') + 't=' + Date.now();
             try { return await fetch(`https://corsproxy.io/?${encodeURIComponent(target)}`); }
             catch { return await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(target)}`); }
        }

        function renderNav() { const nav = document.getElementById('navBar'); nav.innerHTML = ''; MENU.forEach(m => { if(m.subs) { const div = document.createElement('div'); div.className = `nav-item ${m.subs.includes(activeFolder) ? 'active' : ''}`; div.innerHTML = `${m.label} ‚ñæ`; const drop = document.createElement('div'); drop.className = 'dropdown'; m.subs.forEach(sid => { const count = sourceData[sid] ? sourceData[sid].length : 0; const row = document.createElement('div'); row.className = `drop-item ${activeFolder === sid ? 'selected' : ''}`; row.innerHTML = `<span>${FOLDER_CONFIG[sid].label.split(': ')[1] || FOLDER_CONFIG[sid].label}</span> <span class="count">${count}</span>`; row.onclick = (e) => { e.stopPropagation(); switchFolder(sid); }; drop.appendChild(row); }); div.appendChild(drop); nav.appendChild(div); } else { const div = document.createElement('div'); div.className = `nav-item ${activeFolder === m.id ? 'active' : ''}`; div.innerHTML = m.label; const count = sourceData[m.id] ? sourceData[m.id].length : 0; div.innerHTML += ` <span class="count" style="margin-left:5px">${count}</span>`; div.onclick = () => switchFolder(m.id); nav.appendChild(div); } }); }

        function renderGrid() { 
            const grid = document.getElementById('grid'); grid.innerHTML = ''; 
            document.getElementById('folderTitle').innerText = FOLDER_CONFIG[activeFolder].label; 
            const items = sourceData[activeFolder] || []; 
            document.getElementById('countBadge').innerText = items.length + " Sources"; 
            
            items.forEach((item, idx) => { 
                let previewHtml = '<span>No Preview</span>'; let tag = '';
                let dotClass = 'status-err';
                
                // 1. Check Custom Image Override
                if(item.custom_image) {
                     previewHtml = `<img src="${item.custom_image}">`; 
                     tag = `<div class="sim-tag">MANUAL OVERRIDE</div>`; 
                     dotClass = 'status-warn'; 
                }
                // 2. Check Real JSON Output (Fuzzy)
                else {
                    const keys = [item.source_name, item.source_name?.toLowerCase(), item.url, item.url.replace(/\/$/, "")];
                    for(let k of keys) {
                        if(k && newsMap[k]) {
                            previewHtml = `<img src="${newsMap[k]}">`; 
                            tag = `<div class="live-tag">REAL OUTPUT</div>`; 
                            dotClass = 'status-ok'; 
                            break;
                        }
                    }
                }
                
                const card = document.createElement('div'); card.className = 'card'; card.id = `card-${idx}`; 
                card.innerHTML = `<button class="btn-del-corner" onclick="deleteItem(${idx})">√ó</button><div class="status-dot ${dotClass}" title="Set Custom Image" onclick="openOverrideModal(${idx})"></div><div class="card-header"><div class="favicon-wrap"><img src="${getFavicon(item.url)}" class="favicon"><input class="edit-name" value="${item.source_name || ''}" onchange="updateItem(${idx}, 'source_name', this.value)"></div></div><div class="card-image" id="preview-${idx}">${previewHtml}${tag}</div><div class="url-block"><div class="url-actions"><div class="card-label">SOURCE URL</div><button class="btn-analyze" onclick="openLogicAnalyzer('${item.url}', ${idx})">‚ö° ANALYZE</button></div><input id="url-${idx}" class="edit-url" value="${item.url}" onchange="updateItem(${idx}, 'url', this.value)"></div><div class="card-footer"><select class="move-select" onchange="moveItem(${idx}, this.value)"><option value="">Move to...</option>${getMoveOptions(activeFolder)}</select><button class="btn-link-action" onclick="window.open('${item.url}','_blank')">üîó</button></div>`; grid.appendChild(card); 
            }); 
        }
        
        function openOverrideModal(idx) { activeAnalyzerIndex = idx; document.getElementById('overrideInput').value = ''; document.getElementById('overrideModal').classList.add('open'); }
        function applyManualOverride() { const url = document.getElementById('overrideInput').value.trim(); if(!url) return alert("Paste a URL"); if(activeAnalyzerIndex > -1) { sourceData[activeFolder][activeAnalyzerIndex].custom_image = url; sourceData[activeFolder][activeAnalyzerIndex].image_strategy = null; showToast("Image Set! Save to apply."); closeModal('overrideModal'); renderGrid(); } }
        function parsePython(text) { const startIdx = text.indexOf('SOURCES = ['); if(startIdx === -1) return; rawHeader = text.substring(0, startIdx).trim(); const footerStart = text.indexOf('URLS_GLOBAL = ['); if(footerStart > -1) { rawFooter = text.substring(footerStart).trim(); parseListContent(text.substring(startIdx, footerStart).trim()); } else { rawFooter = ""; parseListContent(text.substring(startIdx)); } }
        function parseListContent(str) { str = str.replace('SOURCES = [', '').trim(); if(str.endsWith(']')) str = str.slice(0, -1).trim(); for(let key in FOLDER_CONFIG) sourceData[key] = []; const lines = str.split('\n'); lines.forEach(line => { line = line.trim(); if(!line.startsWith('{')) return; if(line.endsWith(',')) line = line.slice(0, -1); try { const item = JSON.parse(line); const folderId = findFolderId(item); if(folderId) sourceData[folderId].push(item); } catch(e) {} }); }
        function findFolderId(item) { for(let id in FOLDER_CONFIG) { const cfg = FOLDER_CONFIG[id]; let match = true; if(cfg.cat && item.cat !== cfg.cat) match = false; if(cfg.type && item.type !== cfg.type) match = false; if(cfg.tag && item.filter_tag !== cfg.tag) match = false; if(match) return id; } return null; }
        function switchFolder(id) { activeFolder = id; renderNav(); renderGrid(); }
        function getMoveOptions(cid) { let html = ''; for(let id in FOLDER_CONFIG) { if(id !== cid) html += `<option value="${id}">${FOLDER_CONFIG[id].label}</option>`; } return html; }
        function updateItem(idx, f, v) { sourceData[activeFolder][idx][f] = v.trim(); }
        function moveItem(idx, tid) { if(!tid) return; const item = sourceData[activeFolder][idx]; const cfg = FOLDER_CONFIG[tid]; item.cat = cfg.cat; if(cfg.type) item.type = cfg.type; if(cfg.tag) item.filter_tag = cfg.tag; sourceData[activeFolder].splice(idx, 1); sourceData[tid].unshift(item); renderGrid(); renderNav(); showToast("Moved"); }
        function deleteItem(idx) { if(confirm("Are you sure?")) { sourceData[activeFolder].splice(idx, 1); renderGrid(); renderNav(); } }
        function preCheckUrl() { let u = document.getElementById('urlInput'); let val = u.value.trim(); if(val.includes('youtube.com/@') && !val.includes('/videos')) { u.value = val.replace(/\/$/, "") + '/videos'; } }
        function handleAddClick() { const url = document.getElementById('urlInput').value.trim(); const name = document.getElementById('nameInput').value.trim(); if(!url) return alert("URL Required"); const cfg = FOLDER_CONFIG[activeFolder]; let finalName = name || (url.includes('youtube') ? 'YouTube Channel' : 'New Source'); const newItem = { "url": url, "cat": cfg.cat, "type": cfg.type || (url.includes('youtube') ? 'video' : 'web'), "source_name": finalName, "lang": "en" }; if(cfg.tag) newItem.filter_tag = cfg.tag; sourceData[activeFolder].unshift(newItem); document.getElementById('urlInput').value = ''; document.getElementById('nameInput').value = ''; renderGrid(); renderNav(); showToast("Source Added!"); }
        
        // --- SAFE SAVE WITH PYTHON FIX ---
        async function saveToGitHubSafe() { 
            if(!confirm("Overwrite sources.py?")) return; 
            const seenUrls = new Set(); 
            for(let key in sourceData) { 
                const uniqueList = []; 
                sourceData[key].forEach(item => { 
                    const cleanUrl = item.url.trim(); 
                    if(seenUrls.has(cleanUrl)) return; 
                    seenUrls.add(cleanUrl); 
                    if(cleanUrl.includes('.se/') || cleanUrl.includes('.se')) if(item.lang !== 'sv') item.lang = 'sv'; 
                    uniqueList.push(item); 
                }); 
                sourceData[key] = uniqueList; 
            } 
            
            let content = rawHeader + "\n\nSOURCES = [\n"; 
            for(let id in sourceData) { 
                if(sourceData[id].length > 0) { 
                    content += `    # --- ${FOLDER_CONFIG[id].label} ---\n`; 
                    sourceData[id].forEach(item => { 
                        // PYTHON FIX: Convert JSON null/true/false to Python None/True/False
                        let itemStr = JSON.stringify(item);
                        itemStr = itemStr.replace(/":\s*null/g, '": None')
                                         .replace(/":\s*true/g, '": True')
                                         .replace(/":\s*false/g, '": False');
                        content += `    ${itemStr},\n`; 
                    }); 
                } 
            } 
            content += "]\n\n" + rawFooter; 
            
            const encoder = new TextEncoder(); const bytes = encoder.encode(content); let binary = ''; for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]); const encoded = btoa(binary); const user = localStorage.getItem("gh_user"); const repo = localStorage.getItem("gh_repo"); const token = localStorage.getItem("gh_token"); try { const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/sources.py`, { method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ message: "Admin Update (V22.0)", content: encoded, sha: currentSha }) }); if(!res.ok) throw new Error("Save Failed"); const d = await res.json(); currentSha = d.content.sha; showToast("SAVED & CLEANED!"); } catch(e) { alert(e.message); } 
        }
        
        async function deployLive() { const user = localStorage.getItem("gh_user"); const repo = localStorage.getItem("gh_repo"); const token = localStorage.getItem("gh_token"); try { await fetch(`https://api.github.com/repos/${user}/${repo}/actions/workflows/main.yml/dispatches`, { method: 'POST', headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }, body: JSON.stringify({ ref: 'main' }) }); showToast("Deploy Triggered!"); startDeployPolling(); } catch(e) { alert("Deploy Error"); } }
        function startDeployPolling() { const statusBox = document.getElementById('deployStatus'); const statusText = document.getElementById('deployText'); statusBox.style.display = 'flex'; if(deployInterval) clearInterval(deployInterval); deployInterval = setInterval(async () => { const user = localStorage.getItem("gh_user"); const repo = localStorage.getItem("gh_repo"); const token = localStorage.getItem("gh_token"); const res = await fetch(`https://api.github.com/repos/${user}/${repo}/actions/runs?per_page=1`, { headers: { 'Authorization': `token ${token}` } }); const data = await res.json(); const run = data.workflow_runs[0]; statusText.innerText = `${run.status} (${run.conclusion || 'running'})`; if(run.status === 'completed') { clearInterval(deployInterval); statusText.style.color = run.conclusion === 'success' ? '#00ff88' : 'red'; } }, 5000); }
        function openSelector(t) { const b = document.getElementById('selectorButtons'); b.innerHTML = ''; const files = t === 'html' ? ['admin.html', 'template.html'] : ['sources.py', 'generator.py']; files.forEach(f => b.innerHTML += `<button class="btn-file-select" onclick="fetchFileToEdit('${f}'); closeModal('selectorModal')">${f}</button>`); document.getElementById('selectorModal').classList.add('open'); }
        async function fetchFileToEdit(f) { const u=localStorage.getItem("gh_user"), r=localStorage.getItem("gh_repo"), t=localStorage.getItem("gh_token"); try{ const res=await fetch(`https://api.github.com/repos/${u}/${r}/contents/${f}`,{headers:{'Authorization':`token ${t}`}}); const d=await res.json(); currentFileSha=d.sha; currentFileName=f; document.getElementById('codeContent').value=new TextDecoder().decode(Uint8Array.from(atob(d.content),c=>c.charCodeAt(0))); document.getElementById('editorTitle').innerText="EDIT: "+f; document.getElementById('editorModal').classList.add('open'); }catch(e){alert(e.message);} }
        function clearEditor() { document.getElementById('codeContent').value = ""; document.getElementById('codeContent').focus(); }
        async function saveFileContent() { if(!confirm("Overwrite?")) return; const c=document.getElementById('codeContent').value, u=localStorage.getItem("gh_user"), r=localStorage.getItem("gh_repo"), t=localStorage.getItem("gh_token"); const enc=btoa(String.fromCharCode(...new TextEncoder().encode(c))); try{ const res=await fetch(`https://api.github.com/repos/${u}/${r}/contents/${currentFileName}`,{method:'PUT',headers:{'Authorization':`token ${t}`,'Content-Type':'application/json'},body:JSON.stringify({message:`Edit ${currentFileName}`,content:enc,sha:currentFileSha})}); if(!res.ok) throw new Error("Status: " + res.status); const d=await res.json(); currentFileSha=d.content.sha; closeModal('editorModal'); showToast("File Saved!"); if(currentFileName === 'sources.py') { setTimeout(() => fetchSources(u,r,t), 1000); } }catch(e){alert("SAVE FAILED: " + e.message);} }
        function openDumpModal() { document.getElementById('dumpModal').classList.add('open'); }
        function setupDropZone() { const d = document.getElementById('dropZone'); ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => d.addEventListener(e, preventDefaults, false)); ['dragenter', 'dragover'].forEach(e => d.addEventListener(e, () => d.classList.add('dragover'), false)); ['dragleave', 'drop'].forEach(e => d.addEventListener(e, () => d.classList.remove('dragover'), false)); d.addEventListener('drop', handleDrop, false); }
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        function handleDrop(e) { handleFileSelect(e.dataTransfer.files); }
        function handleFileSelect(files) { if(files.length > 0) handleFileDump(files[0]); }
        async function handleFileDump(file) { const user = localStorage.getItem("gh_user"); const repo = localStorage.getItem("gh_repo"); const token = localStorage.getItem("gh_token"); if(!token) return alert("Missing Token"); if(!confirm(`Upload ${file.name}?`)) return; showToast("Uploading..."); closeModal('dumpModal'); const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = async function() { const contentBase64 = reader.result.split(',')[1]; try { const check = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${file.name}`, { headers: {'Authorization': `token ${token}`} }); let sha = null; if(check.ok) sha = (await check.json()).sha; await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${file.name}`, { method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ message: `Dump: ${file.name}`, content: contentBase64, sha: sha }) }); showToast("UPLOAD COMPLETE!"); } catch(e) { alert("Error: " + e.message); } }; }
        function getFavicon(url) { try { const domain = new URL(url).hostname; return `https://icons.duckduckgo.com/ip3/${domain}.ico`; } catch(e) { return "https://via.placeholder.com/20"; } }
        async function runDiagnostics() { /* Simplified */ }
        function showToast(msg, duration=2500) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), duration); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        async function autoDiscoverRSS(url, idx) { alert("Try removing and re-adding via Smart Add."); }
        function forceAddSource() { /* ... */ }
        function searchGoogleForRSS() { /* ... */ }
        
        // VISUAL PROBE LOGIC
        async function openLogicAnalyzer(url, idx) { 
            activeAnalyzerIndex = idx; 
            document.getElementById('testerModal').classList.add('open'); 
            const resBox = document.getElementById('logicResults'); 
            const statusLog = document.getElementById('statusLog'); 
            resBox.innerHTML = ''; 
            statusLog.innerHTML = '1. Fetching... ' + url; 
            
            try { 
                const r = await fetchProxy(url); 
                const rawText = await r.text();
                let text = rawText; 
                try { const j = JSON.parse(rawText); if(j.contents) text = j.contents; } catch(e){} 
                
                statusLog.innerHTML = '2. Scanning...'; 
                
                // Use simple text matching to avoid complex XML parsing bugs
                const strategies = [ 
                    { id: 'og', name: "OpenGraph", val: text.match(/property="og:image" content="([^"]+)"/)?.[1] }, 
                    { id: 'twitter', name: "Twitter", val: text.match(/name="twitter:image" content="([^"]+)"/)?.[1] }, 
                    { id: 'swec', name: "Sweclockers", val: text.match(/(https:\/\/cdn\.sweclockers\.com\/artikel\/bild\/\d+\?l=[^"'\s>]+)/)?.[0].replace(/&amp;/g, "&") }, 
                    { id: 'afton', name: "Aftonbladet", val: text.match(/(https:\/\/images\.aftonbladet-cdn\.se\/v2\/images\/[a-zA-Z0-9\-]+)/)?.[1] }, 
                    { id: 'first_img', name: "First JPG/PNG", val: text.match(/(https?:\/\/[^"'\s]+\.(?:jpg|jpeg|png|webp))/i)?.[1] } 
                ]; 
                
                let htmlOut = ""; 
                strategies.forEach(res => { 
                    const imgTag = res.val ? `<img src="${res.val}" class="strat-preview">` : ''; 
                    htmlOut += `<div class="logic-item ${res.val ? 'success' : 'fail'}"><div class="logic-header"><span>${res.name}</span><button class="btn-apply" onclick="applyStrategy('${res.id}')">‚úÖ USE THIS</button></div><div class="logic-content"><div class="logic-val">${res.val || 'None'}</div>${imgTag}</div></div>`; 
                }); 
                resBox.innerHTML = htmlOut; 
                statusLog.innerHTML = '‚úÖ Done.'; 
            } catch(e) { 
                statusLog.innerHTML = 'Error: ' + e.message; 
            } 
        }
    </script>
</body>
</html>