<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPECULA ADMIN // V5.0 (LOGIC TESTER)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #050505; --surface: #121212; --border: #333; --accent: #00f0ff; --text: #fff; --code-bg: #1e1e1e; --success: #00ff88; --fail: #ff4444; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* HEADER */
        .top-bar { height: 60px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; background: rgba(0,0,0,0.95); z-index: 100; }
        .brand { font-family: 'Space Grotesk'; font-weight: 700; font-size: 1.2rem; letter-spacing: 1px; color: #fff; }
        .brand span { color: var(--accent); }
        
        .actions { display: flex; align-items: center; gap: 8px; }
        .actions button { background: #111; border: 1px solid #444; color: #ccc; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-family: 'Space Grotesk'; font-weight: 700; transition: 0.2s; font-size: 0.8rem; }
        .actions button:hover { border-color: #fff; color: #fff; }
        .btn-save { background: var(--accent) !important; color: #000 !important; border-color: var(--accent) !important; }
        
        /* NAV & GRID */
        .nav-container { display: flex; align-items: center; padding: 0 30px; height: 50px; background: #0a0a0a; border-bottom: 1px solid var(--border); gap: 10px; z-index: 90; }
        .nav-item { position: relative; padding: 8px 12px; cursor: pointer; font-family: 'Space Grotesk'; font-weight: 700; font-size: 0.8rem; color: #666; text-transform: uppercase; display: flex; align-items: center; gap: 5px; border-radius: 4px; }
        .nav-item:hover { color: #fff; background: #1a1a1a; }
        .nav-item.active { color: #000; background: var(--accent); }
        .main-view { flex-grow: 1; padding: 30px; overflow-y: auto; background: radial-gradient(circle at 50% 20%, #111 0%, #050505 60%); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 15px; }
        
        /* CARD */
        .card { background: #141414; border: 1px solid #2a2a2a; border-radius: 6px; padding: 15px; transition: 0.2s; display: flex; flex-direction: column; gap: 8px; }
        .card:hover { border-color: #555; background: #1a1a1a; transform: translateY(-2px); }
        .card-label { font-size: 0.65rem; color: #555; text-transform: uppercase; font-weight: bold; margin-bottom: -5px; }
        .edit-name { background: transparent; border: none; border-bottom: 1px solid #333; color: #fff; font-family: 'Space Grotesk'; font-weight: 700; font-size: 1rem; width: 100%; padding: 4px 0; }
        .edit-name:focus { border-color: var(--accent); outline: none; }
        .url-row { display: flex; gap: 5px; }
        .edit-url { background: #000; border: 1px solid #333; color: #bbb; font-family: monospace; font-size: 0.75rem; width: 100%; padding: 6px; border-radius: 4px; }
        .edit-url:focus { border-color: var(--accent); color: #fff; outline: none; }
        
        .btn-mini { background: #222; border: 1px solid #444; color: #fff; padding: 0 8px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 30px; }
        .btn-mini:hover { background: #333; border-color: #fff; }
        .btn-magic { color: var(--accent); border-color: #004455; }
        .btn-test { color: #ccff00; border-color: #445500; }
        .btn-test:hover { background: #ccff00; color: #000; }

        .card-actions { display: flex; gap: 10px; border-top: 1px solid #222; padding-top: 10px; margin-top: 5px; }
        .move-select { background: #000; color: #aaa; border: 1px solid #333; padding: 6px; border-radius: 4px; width: 100%; font-size: 0.75rem; cursor: pointer; }
        
        /* TESTER MODAL */
        .tester-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .tester-overlay.open { display: flex; }
        .tester-window { width: 90%; max-width: 800px; max-height: 90vh; background: #111; border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; padding: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        .tester-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .tester-input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .tester-input { flex-grow: 1; padding: 12px; background: #000; border: 1px solid #333; color: #fff; border-radius: 4px; font-family: monospace; }
        .tester-btn { background: var(--accent); color: #000; border: none; padding: 0 20px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        
        .results-area { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .result-row { background: #1a1a1a; padding: 15px; border-radius: 6px; border-left: 4px solid #333; display: flex; flex-direction: column; gap: 5px; }
        .result-row.success { border-left-color: var(--success); background: rgba(0, 255, 136, 0.05); }
        .result-row.fail { border-left-color: var(--fail); opacity: 0.5; }
        .result-name { font-weight: bold; font-family: 'Space Grotesk'; font-size: 0.9rem; }
        .result-val { font-family: monospace; font-size: 0.75rem; color: #aaa; word-break: break-all; }
        .preview-img { max-width: 100%; height: auto; margin-top: 10px; border-radius: 4px; border: 1px solid #333; }

        /* CODE EDITOR STYLES */
        .editor-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .editor-overlay.open { display: flex; }
        .editor-window { width: 90%; max-width: 1000px; height: 85vh; background: #111; border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; padding: 20px; }
        .code-area { flex-grow: 1; background: var(--code-bg); color: #ccc; border: 1px solid var(--border); font-family: monospace; padding: 15px; font-size: 0.9rem; resize: none; border-radius: 6px; white-space: pre-wrap; overflow-y: auto; }
        
        /* FOOTER ADD */
        .add-bar { height: 70px; border-top: 1px solid var(--border); background: #080808; display: flex; align-items: center; padding: 0 30px; gap: 10px; }
        .add-input { background: #111; border: 1px solid #333; color: white; padding: 12px; border-radius: 4px; font-family: 'Inter'; font-size: 0.9rem; }

        /* TOAST */
        .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: #1a1a1a; border: 1px solid var(--accent); color: var(--accent); padding: 10px 25px; border-radius: 30px; opacity: 0; pointer-events: none; transition: 0.3s; font-weight: bold; z-index: 999; }
        .toast.show { opacity: 1; top: 90px; }
    </style>
</head>
<body>

    <input type="hidden" id="ghUser" value="specula-news">
    <input type="hidden" id="ghRepo" value="specula">
    <input type="hidden" id="ghToken" value=""> 

    <div class="top-bar">
        <div class="brand">SPECULA <span>// ADMIN V5.0</span></div>
        <div class="actions">
            <button onclick="openEditor('template.html')">üìù HTML</button>
            <button onclick="openEditor('generator.py')">‚öôÔ∏è PY</button>
            <button onclick="fetchSources()">‚Üª Reload</button>
            <button onclick="deployLive()">üöÄ Deploy</button>
            <button class="btn-save" onclick="saveToGitHub()">üíæ SAVE LIST</button>
        </div>
    </div>

    <div class="nav-container" id="navBar"></div>

    <div class="main-view">
        <div class="view-header">
            <span id="folderTitle">LOADING...</span>
            <span class="view-badge" id="countBadge">0</span>
        </div>
        <div class="grid" id="grid"></div>
    </div>

    <!-- TESTER MODAL -->
    <div class="tester-overlay" id="testerModal">
        <div class="tester-window">
            <div class="tester-header">
                <div class="editor-title">üß™ IMAGE LOGIC TESTER</div>
                <button class="btn-mini" onclick="closeTester()" style="font-size:1.2rem;">√ó</button>
            </div>
            <div style="font-size:0.8rem; color:#666; margin-bottom:10px;">
                Paste an <b>ARTICLE URL</b> below (not the RSS feed) to check if the Python logic can find the image.
            </div>
            <div class="tester-input-group">
                <input type="text" id="testUrlInput" class="tester-input" placeholder="e.g. https://www.sweclockers.com/nyhet/...">
                <button class="tester-btn" onclick="runLogicTest()">ANALYZE</button>
            </div>
            <div id="testResults" class="results-area">
                <div style="color:#444; text-align:center; margin-top:50px;">Waiting for input...</div>
            </div>
        </div>
    </div>

    <!-- CODE EDITOR MODAL -->
    <div class="editor-overlay" id="editorModal">
        <div class="editor-window">
            <div class="editor-header">
                <div class="editor-title" id="editorTitle">EDITING FILE</div>
                <button class="btn-mini" onclick="closeEditor()" style="font-size:1rem;">√ó</button>
            </div>
            <textarea id="codeContent" class="code-area" spellcheck="false"></textarea>
            <div class="editor-controls" style="margin-top:15px; display:flex; justify-content:space-between;">
                <button class="actions" style="background:#330000; color:#ff5555; border:1px solid #550000;" onclick="clearEditor()">üóëÔ∏è CLEAR ALL</button>
                <div style="display:flex; gap:10px;">
                    <button class="actions" style="background:#333; color:white; border:none;" onclick="closeEditor()">Cancel</button>
                    <button class="actions btn-save" style="border:none;" onclick="saveFileContent()">üíæ SAVE TO GITHUB</button>
                </div>
            </div>
        </div>
    </div>

    <div class="add-bar">
        <input type="text" id="urlInput" class="add-input" placeholder="URL (e.g. www.sweclockers.com)..." style="flex-grow: 2;" oninput="autoSmartFixAdd()">
        <input type="text" id="nameInput" class="add-input" placeholder="Name (Auto)" style="flex-grow: 1;">
        <button class="actions btn-save" style="border:none; padding:12px 24px; cursor:pointer;" onclick="addSource()">+ ADD</button>
    </div>

    <div id="toast" class="toast">Action Saved</div>

    <script>
        // ===============================================
        // LOGIC TESTER (THE NEW FEATURE)
        // ===============================================
        function openTester(url) {
            document.getElementById('testUrlInput').value = url || "";
            document.getElementById('testResults').innerHTML = '<div style="color:#444; text-align:center; margin-top:50px;">Ready to analyze...</div>';
            document.getElementById('testerModal').classList.add('open');
        }

        function closeTester() {
            document.getElementById('testerModal').classList.remove('open');
        }

        async function runLogicTest() {
            const url = document.getElementById('testUrlInput').value.trim();
            if (!url) return alert("Enter an Article URL!");

            const resDiv = document.getElementById('testResults');
            resDiv.innerHTML = '<div style="color:var(--accent); text-align:center; margin-top:50px;">Fetching via Proxy...</div>';

            try {
                // Use AllOrigins Proxy to bypass CORS
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error("Proxy Fetch Failed");
                const html = await response.text();

                let resultsHTML = "";
                let foundImage = null;

                // --- 1. SWECLOCKERS REGEX ---
                // Python: r'(https://cdn\.sweclockers\.com/artikel/bild/\d+\?l=[^"\'\s>]+)'
                const swecRegex = /(https:\/\/cdn\.sweclockers\.com\/artikel\/bild\/\d+\?l=[^"'\s>]+)/g;
                const swecMatches = html.match(swecRegex);
                let swecRes = null;
                if (swecMatches) {
                    swecRes = swecMatches.reduce((a, b) => a.length > b.length ? a : b).replace(/&amp;/g, "&");
                    if (!foundImage) foundImage = swecRes;
                }
                resultsHTML += renderResult("1. Sweclockers Regex (?l=)", swecRes);

                // --- 2. AFTONBLADET REGEX ---
                // Python: r'(https://images\.aftonbladet-cdn\.se/v2/images/[a-zA-Z0-9\-]+)'
                const abRegex = /(https:\/\/images\.aftonbladet-cdn\.se\/v2\/images\/[a-zA-Z0-9\-]+)/g;
                const abMatches = html.match(abRegex);
                let abRes = null;
                if (abMatches) {
                    abRes = abMatches[0];
                    if (!foundImage) foundImage = abRes;
                }
                resultsHTML += renderResult("2. Aftonbladet Regex", abRes);

                // --- 3. JSON-LD ---
                let jsonRes = null;
                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, "text/html");
                    const scripts = doc.querySelectorAll('script[type="application/ld+json"]');
                    scripts.forEach(s => {
                        try {
                            const data = JSON.parse(s.innerText);
                            const item = Array.isArray(data) ? data[0] : data;
                            if (item.image) {
                                if (typeof item.image === 'string') jsonRes = item.image;
                                else if (item.image.url) jsonRes = item.image.url;
                            }
                        } catch(e){}
                    });
                } catch(e){}
                if (jsonRes && !foundImage) foundImage = jsonRes;
                resultsHTML += renderResult("3. JSON-LD (Schema.org)", jsonRes);

                // --- 4. OPEN GRAPH ---
                let ogRes = null;
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");
                const ogTag = doc.querySelector('meta[property="og:image"]');
                if (ogTag) ogRes = ogTag.getAttribute('content');
                if (ogRes && !foundImage) foundImage = ogRes;
                resultsHTML += renderResult("4. OpenGraph (Generic)", ogRes);

                // --- PREVIEW ---
                if (foundImage) {
                    resultsHTML = `<div style="text-align:center; margin-bottom:20px;">
                        <div style="color:#00ff88; font-weight:bold; margin-bottom:5px;">‚úÖ SUCCESS: IMAGE FOUND</div>
                        <img src="${foundImage}" class="preview-img" style="max-height:200px;">
                    </div>` + resultsHTML;
                } else {
                    resultsHTML = `<div style="text-align:center; color:#ff4444; font-weight:bold; margin-bottom:20px;">‚ùå FAILED TO FIND IMAGE</div>` + resultsHTML;
                }

                resDiv.innerHTML = resultsHTML;

            } catch (e) {
                resDiv.innerHTML = `<div style="color:red; text-align:center; margin-top:50px;">Error: ${e.message}<br>Could not fetch URL.</div>`;
            }
        }

        function renderResult(name, value) {
            const statusClass = value ? "success" : "fail";
            return `<div class="result-row ${statusClass}">
                <div class="result-name">${name}</div>
                <div class="result-val">${value || "Not Found"}</div>
            </div>`;
        }

        // ===============================================
        // GRID RENDER WITH NEW BUTTON
        // ===============================================
        function renderGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            document.getElementById('folderTitle').innerText = FOLDER_CONFIG[activeFolder].label;
            const items = sourceData[activeFolder] || [];
            document.getElementById('countBadge').innerText = items.length;
            
            items.forEach((item, idx) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-label">NAME</div>
                    <input class="edit-name" value="${item.source_name || ''}" onchange="updateItem(${idx}, 'source_name', this.value)">
                    <div class="card-label">URL</div>
                    <div class="url-row">
                        <input id="url-${idx}" class="edit-url" value="${item.url}" onchange="updateItem(${idx}, 'url', this.value)">
                        <button class="btn-mini" title="Test Link" onclick="testUrl(${idx})">üîó</button>
                        <button class="btn-mini btn-test" title="Test Image Logic" onclick="openTester()">üß™</button>
                        <button class="btn-mini btn-magic" title="Convert to RSS" onclick="magicFix(${idx})">ü™Ñ</button>
                    </div>
                    <div class="card-actions">
                        <select class="move-select" onchange="moveItem(${idx}, this.value)">
                            <option value="">Move to...</option>
                            ${getMoveOptions(activeFolder)}
                        </select>
                        <button class="btn-mini" style="background:transparent; color:#555; width:30px;" onclick="deleteItem(${idx})">√ó</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // ===============================================
        // EDITOR STUFF (Existing)
        // ===============================================
        let currentFileSha = "";
        let currentFileName = "";

        async function openEditor(filename) {
            const user = document.getElementById('ghUser').value;
            const repo = document.getElementById('ghRepo').value;
            const token = document.getElementById('ghToken').value;
            if(!token) return alert("Missing GitHub Token");
            showToast("Fetching " + filename + "...");
            try {
                const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${filename}`, { headers: { 'Authorization': `token ${token}` } });
                if(!res.ok) throw new Error("Could not load file");
                const data = await res.json();
                currentFileSha = data.sha;
                currentFileName = filename;
                const content = new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0)));
                document.getElementById('codeContent').value = content;
                document.getElementById('editorTitle').innerText = "EDITING: " + filename;
                document.getElementById('editorModal').classList.add('open');
            } catch(e) { alert("Error loading file: " + e.message); }
        }

        function clearEditor() { document.getElementById('codeContent').value = ""; document.getElementById('codeContent').focus(); }
        async function saveFileContent() {
            if(!confirm(`Overwrite ${currentFileName} on GitHub?`)) return;
            const content = document.getElementById('codeContent').value;
            const user = document.getElementById('ghUser').value;
            const repo = document.getElementById('ghRepo').value;
            const token = document.getElementById('ghToken').value;
            const encoder = new TextEncoder();
            const bytes = encoder.encode(content);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
            const encoded = btoa(binary);
            showToast("Uploading...");
            try {
                const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${currentFileName}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: `Admin Edit: ${currentFileName}`, content: encoded, sha: currentFileSha })
                });
                if(!res.ok) throw new Error("Save Failed");
                const d = await res.json();
                currentFileSha = d.content.sha;
                showToast("FILE SAVED!", 2000);
            } catch(e) { alert("Error saving: " + e.message); }
        }
        function closeEditor() { document.getElementById('editorModal').classList.remove('open'); document.getElementById('codeContent').value = ""; }

        // ===============================================
        // REST OF THE APP
        // ===============================================
        const SMART_RSS_MAP = {
            "sweclockers": "https://www.sweclockers.com/feeds/nyheter", "fz.se": "https://www.fz.se/feeds/nyheter", "fz": "https://www.fz.se/feeds/nyheter", "nyteknik": "https://www.nyteknik.se/rss", "feber": "https://feber.se/rss/", "aftonbladet": "https://rss.aftonbladet.se/rss2/small/pages/sections/nyheter/", "expressen": "https://feeds.expressen.se/nyheter/", "omni": "https://omni.se/rss/nyheter", "dagensps": "https://www.dagensps.se/feed/", "efn": "https://efn.se/feeds/feed.xml", "elbilen": "https://elbilen.se/feed/", "alltomelbil": "https://alltomelbil.se/feed/", "teslaclubsweden": "https://teslaclubsweden.se/feed/", "byggvarlden": "https://www.byggvarlden.se/feed/", "byggindustrin": "https://www.byggindustrin.se/rss/nyheter", "theverge": "https://www.theverge.com/rss/index.xml", "wired": "https://www.wired.com/feed/rss", "techcrunch": "https://techcrunch.com/feed/", "engadget": "https://www.engadget.com/rss.xml", "arstechnica": "https://feeds.arstechnica.com/arstechnica/index", "mashable": "https://mashable.com/feeds/rss/tech", "space.com": "https://www.space.com/feeds/all", "nasa": "https://www.nasa.gov/rss/dyn/breaking_news.rss", "electrek": "https://electrek.co/feed/", "insideevs": "https://insideevs.com/rss/articles/all/", "cleantechnica": "https://cleantechnica.com/feed/", "oilprice": "https://oilprice.com/rss/main", "eurogamer": "https://www.eurogamer.net/feed", "pcgamer": "https://www.pcgamer.com/rss", "kotaku": "https://kotaku.com/rss", "polygon": "https://www.polygon.com/rss/index.xml", "ign": "https://feeds.ign.com/ign/news", "gamespot": "https://www.gamespot.com/feeds/news/", "bbc": "http://feeds.bbci.co.uk/news/world/rss.xml", "cnn": "http://rss.cnn.com/rss/edition.rss", "aljazeera": "https://www.aljazeera.com/xml/rss/all.xml", "reuters": "https://www.reutersagency.com/feed/", "cnbc": "https://www.cnbc.com/id/100727362/device/rss/rss.html", "scmp": "https://www.scmp.com/rss/91/feed", "politico": "https://www.politico.eu/feed/"
        };

        const FOLDER_CONFIG = {
            'GLOBAL_WEB': { label: 'NEWS: GLOBAL', cat: 'geopolitics', type: 'web', tag: 'global' },
            'MEDIA_GLOBAL': { label: 'MEDIA: Global', cat: 'geopolitics', type: 'video', tag: 'global' },
            'MEDIA_CHINA':  { label: 'MEDIA: China',  cat: 'geopolitics', type: 'video', tag: 'china' },
            'MEDIA_USA':    { label: 'MEDIA: USA',    cat: 'geopolitics', type: 'video', tag: 'usa' },
            'MEDIA_INDIA':  { label: 'MEDIA: India',  cat: 'geopolitics', type: 'video', tag: 'india' },
            'YT_GEO':    { label: 'YT: Geo',    cat: 'youtubers', type: 'video', tag: 'geo' },
            'YT_TECH':   { label: 'YT: Tech',   cat: 'youtubers', type: 'video', tag: 'tech' },
            'YT_ENERGY': { label: 'YT: Energy', cat: 'youtubers', type: 'video', tag: 'energy' },
            'YT_EV':     { label: 'YT: EV',     cat: 'youtubers', type: 'video', tag: 'ev' },
            'YT_GAME':   { label: 'YT: Gaming', cat: 'youtubers', type: 'video', tag: 'gaming' },
            'GAME_WEB': { label: 'GAME: News', cat: 'gaming', type: 'web', tag: null },
            'GAME_EWC': { label: 'GAME: Video', cat: 'gaming', type: 'video', tag: null },
            'TOPIC_TECH':   { label: 'TOPIC: Tech', cat: 'tech', type: 'web', tag: null },
            'TOPIC_ENERGY': { label: 'TOPIC: Energy', cat: 'energy', type: 'web', tag: null },
            'TOPIC_EV':     { label: 'TOPIC: EV', cat: 'ev', type: 'web', tag: null },
            'TOPIC_SCI':    { label: 'TOPIC: Science', cat: 'science', type: null, tag: null },
            'TOPIC_CONST':  { label: 'TOPIC: Constr', cat: 'construction', type: null, tag: null },
            'ECONOMY': { label: 'ECONOMY', cat: 'economy', type: null, tag: null },
            'GEO_SWE': { label: 'GEO: Sweden', cat: 'geopolitics', type: 'web', tag: 'sweden' },
            'GEO_EU':  { label: 'GEO: EU', cat: 'geopolitics', type: 'video', tag: 'eu' }
        };

        const MENU = [
            { id: 'GLOBAL_WEB', label: 'ALL NEWS' },
            { label: 'MEDIA', subs: ['MEDIA_GLOBAL', 'MEDIA_CHINA', 'MEDIA_USA', 'MEDIA_INDIA'] },
            { label: 'YOUTUBERS', subs: ['YT_GEO', 'YT_TECH', 'YT_ENERGY', 'YT_EV', 'YT_GAME'] },
            { label: 'GAMING', subs: ['GAME_WEB', 'GAME_EWC'] },
            { label: 'TOPICS', subs: ['TOPIC_TECH', 'TOPIC_ENERGY', 'TOPIC_EV', 'TOPIC_SCI', 'TOPIC_CONST', 'ECONOMY'] },
            { label: 'GEOPOLITICS', subs: ['GEO_SWE', 'GEO_EU'] }
        ];

        let sourceData = {}; let rawHeader = ""; let rawFooter = ""; let currentSha = ""; let activeFolder = 'GLOBAL_WEB';

        window.onload = function() {
            for(let key in FOLDER_CONFIG) sourceData[key] = [];
            const t = prompt("Enter GitHub Token (ghp_...):");
            if(t) { document.getElementById('ghToken').value = t; fetchSources(); }
        };

        async function fetchSources() {
            const user = document.getElementById('ghUser').value; const repo = document.getElementById('ghRepo').value; const token = document.getElementById('ghToken').value;
            try {
                const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/sources.py`, { headers: { 'Authorization': `token ${token}` } });
                if(!res.ok) throw new Error("Connection Failed");
                const data = await res.json();
                currentSha = data.sha;
                const text = new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0)));
                parsePython(text); renderNav(); renderGrid(); showToast("Data Loaded");
            } catch(e) { alert(e.message); }
        }

        function parsePython(text) {
            const startIdx = text.indexOf('SOURCES = ['); if(startIdx === -1) return alert("Could not find SOURCES = [...]");
            rawHeader = text.substring(0, startIdx).trim();
            const footerStart = text.indexOf('URLS_GLOBAL = [');
            if(footerStart > -1) { rawFooter = text.substring(footerStart).trim(); parseListContent(text.substring(startIdx, footerStart).trim()); } 
            else { rawFooter = ""; parseListContent(text.substring(startIdx)); }
        }

        function parseListContent(str) {
            str = str.replace('SOURCES = [', '').trim();
            if(str.endsWith(']')) str = str.slice(0, -1).trim();
            for(let key in FOLDER_CONFIG) sourceData[key] = [];
            const lines = str.split('\n');
            lines.forEach(line => {
                line = line.trim(); if(!line.startsWith('{')) return;
                if(line.endsWith(',')) line = line.slice(0, -1);
                try {
                    const item = JSON.parse(line);
                    const folderId = findFolderId(item);
                    if(folderId) sourceData[folderId].push(item);
                } catch(e) {}
            });
        }

        function findFolderId(item) {
            for(let id in FOLDER_CONFIG) {
                const cfg = FOLDER_CONFIG[id];
                let match = true;
                if(cfg.cat && item.cat !== cfg.cat) match = false;
                if(cfg.type && item.type !== cfg.type) match = false;
                if(cfg.tag && item.filter_tag !== cfg.tag) match = false;
                if(match) return id;
            } return null;
        }

        function renderNav() {
            const nav = document.getElementById('navBar'); nav.innerHTML = '';
            MENU.forEach(m => {
                if(m.subs) {
                    const div = document.createElement('div'); div.className = `nav-item ${m.subs.includes(activeFolder) ? 'active' : ''}`;
                    div.innerHTML = `${m.label} ‚ñæ`;
                    const drop = document.createElement('div'); drop.className = 'dropdown';
                    m.subs.forEach(sid => {
                        const count = sourceData[sid] ? sourceData[sid].length : 0;
                        const row = document.createElement('div'); row.className = `drop-item ${activeFolder === sid ? 'selected' : ''}`;
                        row.innerHTML = `<span>${FOLDER_CONFIG[sid].label.split(': ')[1] || FOLDER_CONFIG[sid].label}</span> <span class="count">${count}</span>`;
                        row.onclick = (e) => { e.stopPropagation(); switchFolder(sid); };
                        drop.appendChild(row);
                    });
                    div.appendChild(drop); nav.appendChild(div);
                } else {
                    const div = document.createElement('div'); div.className = `nav-item ${activeFolder === m.id ? 'active' : ''}`;
                    div.innerHTML = m.label;
                    const count = sourceData[m.id] ? sourceData[m.id].length : 0;
                    div.innerHTML += ` <span class="count" style="margin-left:5px">${count}</span>`;
                    div.onclick = () => switchFolder(m.id); nav.appendChild(div);
                }
            });
        }

        function switchFolder(id) { activeFolder = id; renderNav(); renderGrid(); }
        function getMoveOptions(currentId) { let html = ''; for(let id in FOLDER_CONFIG) { if(id !== currentId) html += `<option value="${id}">${FOLDER_CONFIG[id].label}</option>`; } return html; }
        function updateItem(idx, field, val) { sourceData[activeFolder][idx][field] = val.trim(); }
        function testUrl(idx) { const url = document.getElementById(`url-${idx}`).value; window.open(url, '_blank'); }
        function magicFix(idx) {
            const input = document.getElementById(`url-${idx}`); const val = input.value.toLowerCase();
            if(val.includes('youtube.com/@') && !val.includes('/videos')) { input.value = val.replace(/\/$/, "") + '/videos'; updateItem(idx, 'url', input.value); return showToast("YouTube Fixed! ü™Ñ"); }
            for (let key in SMART_RSS_MAP) { if (val.includes(key)) { input.value = SMART_RSS_MAP[key]; updateItem(idx, 'url', input.value); return showToast("RSS Fixed! ü™Ñ"); } }
            alert("No fix found.");
        }
        function moveItem(idx, targetId) {
            if(!targetId) return;
            const item = sourceData[activeFolder][idx]; const cfg = FOLDER_CONFIG[targetId];
            item.cat = cfg.cat; if(cfg.type) item.type = cfg.type; if(cfg.tag) item.filter_tag = cfg.tag;
            sourceData[activeFolder].splice(idx, 1); sourceData[targetId].unshift(item);
            renderGrid(); renderNav(); showToast("Moved");
        }
        function deleteItem(idx) { if(confirm("Delete source?")) { sourceData[activeFolder].splice(idx, 1); renderGrid(); renderNav(); } }
        function autoSmartFixAdd() {
            let u = document.getElementById('urlInput'); let val = u.value.toLowerCase().trim();
            if(val.includes('youtube.com/@') && !val.includes('/videos')) { u.value = val.replace(/\/$/, "") + '/videos'; return; }
            if(!val.includes('rss') && !val.includes('feed') && !val.includes('.xml')) { for (let key in SMART_RSS_MAP) { if (val.includes(key)) { u.value = SMART_RSS_MAP[key]; document.getElementById('nameInput').value = key.charAt(0).toUpperCase() + key.slice(1); showToast("RSS Detected!"); return; } } }
        }
        function addSource() {
            autoSmartFixAdd();
            const url = document.getElementById('urlInput').value.trim(); const name = document.getElementById('nameInput').value.trim();
            if(!url) return alert("URL Required");
            const cfg = FOLDER_CONFIG[activeFolder];
            let finalName = name || (url.includes('youtube') ? 'YouTube Channel' : 'New Source');
            const newItem = { "url": url, "cat": cfg.cat, "type": cfg.type || (url.includes('youtube') ? 'video' : 'web'), "source_name": finalName, "lang": "en" };
            if(cfg.tag) newItem.filter_tag = cfg.tag;
            sourceData[activeFolder].unshift(newItem);
            document.getElementById('urlInput').value = ''; document.getElementById('nameInput').value = '';
            renderGrid(); renderNav(); showToast("Added Source");
        }
        async function saveToGitHub() {
            if(!confirm("Overwrite sources.py on GitHub?")) return;
            let content = rawHeader + "\n\nSOURCES = [\n";
            for(let id in sourceData) { if(sourceData[id].length > 0) { content += `    # --- ${FOLDER_CONFIG[id].label} ---\n`; sourceData[id].forEach(item => { content += `    ${JSON.stringify(item)},\n`; }); } }
            content += "]\n\n" + rawFooter;
            const encoder = new TextEncoder(); const bytes = encoder.encode(content);
            let binary = ''; for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
            const encoded = btoa(binary);
            const user = document.getElementById('ghUser').value; const repo = document.getElementById('ghRepo').value; const token = document.getElementById('ghToken').value;
            try {
                const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/sources.py`, { method: 'PUT', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ message: "Admin Update (V5.0)", content: encoded, sha: currentSha }) });
                if(!res.ok) throw new Error("Save Failed");
                const d = await res.json(); currentSha = d.content.sha; showToast("SAVED SUCCESSFULLY!");
            } catch(e) { alert(e.message); }
        }
        function showToast(msg, d=2000) { const t = document.getElementById('toast'); t.innerText = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), d); }
        async function deployLive() {
             const user = document.getElementById('ghUser').value; const repo = document.getElementById('ghRepo').value; const token = document.getElementById('ghToken').value;
            try { await fetch(`https://api.github.com/repos/${user}/${repo}/actions/workflows/main.yml/dispatches`, { method: 'POST', headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' }, body: JSON.stringify({ ref: 'main' }) }); showToast("Deploy Started"); } catch(e) { alert("Deploy Error"); }
        }
    </script>
</body>
</html>