<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPECULA ADMIN // V12.4</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050505; --surface: #121212; --border: #333; --accent: #00f0ff; --text: #fff; --success: #00ff88; --warning: #ffaa00; --fail: #ff4444; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { height: 70px; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; background: rgba(0,0,0,0.95); z-index: 100; gap: 20px; }
        .brand { font-family: 'Space Grotesk'; font-weight: 700; font-size: 1.2rem; color: #fff; } .brand span { color: var(--accent); }
        .actions { display: flex; gap: 10px; margin-left: auto; }
        button { font-family: 'Space Grotesk'; font-weight: 700; cursor: pointer; border-radius: 4px; border: 1px solid #444; background: #111; color: #ccc; padding: 8px 16px; font-size: 0.75rem; }
        button:hover { border-color: #fff; color: #fff; }
        .btn-save { background: var(--accent) !important; color: #000 !important; }
        .btn-logout { border-color: #ff4444; color: #ff4444; }
        .main-view { flex-grow: 1; padding: 30px; overflow-y: auto; background: radial-gradient(circle at 50% 20%, #111 0%, #050505 60%); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .card { background: #141414; border: 1px solid #2a2a2a; border-radius: 8px; padding: 15px; }
        .card-image { width: 100%; height: 160px; background: #080808; border-radius: 4px; margin-bottom: 10px; position: relative; overflow: hidden; display:flex; align-items:center; justify-content:center; border:1px solid #333; }
        .card-image img { width: 100%; height: 100%; object-fit: cover; }
        .live-tag { position: absolute; top: 5px; right: 5px; background: var(--success); color: #000; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .sim-tag { position: absolute; top: 5px; right: 5px; background: var(--warning); color: #000; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .edit-name, .edit-url { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 8px; margin-bottom: 5px; font-size: 0.8rem; border-radius: 4px; }
        .edit-name { font-weight: bold; font-size: 1rem; border: none; background: transparent; padding: 0; margin-bottom: 10px; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .overlay.open { display: flex; }
        .modal { background: #111; border: 1px solid var(--border); border-radius: 12px; padding: 25px; width: 600px; max-height: 80vh; overflow-y: auto; }
        .logic-item { background: #1a1a1a; padding: 10px; margin-bottom: 8px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--success); }
        .logic-preview { width: 80px; height: 50px; object-fit: cover; background: #000; border-radius: 4px; margin-right: 15px; }
        .btn-apply { background: var(--success); color: #000; border: none; padding: 5px 15px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        .nav-container { display: flex; gap: 10px; padding: 10px 20px; background: #0a0a0a; border-bottom: 1px solid var(--border); overflow-x: auto; }
        .nav-item { padding: 8px 12px; background: #111; border-radius: 4px; color: #666; cursor: pointer; white-space: nowrap; font-weight: bold; font-size: 0.8rem; }
        .nav-item.active { background: var(--accent); color: #000; }
        /* UTILS */
        .login-box { width: 400px; text-align: center; gap: 15px; display:flex; flex-direction:column; }
        .login-input { padding: 10px; background: #000; border: 1px solid #333; color: #fff; }
    </style>
</head>
<body>

    <div class="overlay open" id="loginModal" style="z-index:9999;">
        <div class="modal login-box">
            <h2 style="color:var(--accent); margin:0;">SPECULA CONFIG</h2>
            <input type="text" id="userInput" class="login-input" value="specula-news">
            <input type="text" id="repoInput" class="login-input" value="specula">
            <input type="password" id="tokenInput" class="login-input" placeholder="ghp_...">
            <button onclick="performLogin()" style="background:var(--accent); color:#000; border:none; padding:10px; font-weight:bold;">UNLOCK</button>
        </div>
    </div>

    <div class="top-bar">
        <div class="brand">SPECULA <span>// V12.4</span></div>
        <div class="actions">
            <button onclick="openDump()">üìÇ DUMP</button>
            <button onclick="openEdit('html')">üìù HTML</button>
            <button onclick="openEdit('py')">‚öôÔ∏è PY</button>
            <button onclick="fetchSources()">‚Üª</button>
            <button onclick="deploy()">üöÄ DEPLOY</button>
            <button class="btn-save" onclick="saveToGitHub()">üíæ SAVE</button>
            <button onclick="logout()" style="color:red">LOGOUT</button>
        </div>
    </div>

    <div class="nav-container" id="navBar"></div>
    <div class="main-view"><div class="grid" id="grid"></div></div>

    <!-- ANALYZER -->
    <div class="overlay" id="testerModal">
        <div class="modal">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3>Working Image Logics</h3>
                <button onclick="closeModal('testerModal')" style="background:none; border:none; color:#fff; font-size:1.5rem;">√ó</button>
            </div>
            <div id="logicResults"></div>
        </div>
    </div>

    <!-- DUMP & EDIT MODALS OMITTED FOR BREVITY, SAME AS BEFORE -->
    <div class="overlay" id="dumpModal"><div class="modal"><input type="file" onchange="handleFile(this.files)"></div></div>
    <div class="overlay" id="editorModal"><div class="modal"><textarea id="codeContent" style="width:100%; height:400px; background:#000; color:#ccc;"></textarea><button onclick="saveFile()">SAVE</button><button onclick="closeModal('editorModal')">CLOSE</button></div></div>

    <script>
        let sourceData = {}, newsMap = {}, activeFolder = 'GLOBAL_WEB', currentSha = "";
        const FOLDER_CONFIG = { 'GLOBAL_WEB': { label: 'NEWS: GLOBAL', cat: 'geopolitics', type: 'web', tag: 'global' }, 'GEO_SWE': { label: 'GEO: Sweden', cat: 'geopolitics', type: 'web', tag: 'sweden' }, 'YT_TECH': { label: 'YT: Tech', cat: 'youtubers', type: 'video', tag: 'tech' }, 'MEDIA_GLOBAL': { label: 'MEDIA: Global', cat: 'geopolitics', type: 'video', tag: 'global' }, 'MEDIA_CHINA': { label: 'MEDIA: China', cat: 'geopolitics', type: 'video', tag: 'china' }, 'MEDIA_USA': { label: 'MEDIA: USA', cat: 'geopolitics', type: 'video', tag: 'usa' }, 'MEDIA_INDIA': { label: 'MEDIA: India', cat: 'geopolitics', type: 'video', tag: 'india' }, 'YT_GEO': { label: 'YT: Geo', cat: 'youtubers', type: 'video', tag: 'geo' }, 'YT_ENERGY': { label: 'YT: Energy', cat: 'youtubers', type: 'video', tag: 'energy' }, 'YT_EV': { label: 'YT: EV', cat: 'youtubers', type: 'video', tag: 'ev' }, 'YT_GAME': { label: 'YT: Gaming', cat: 'youtubers', type: 'video', tag: 'gaming' }, 'GAME_WEB': { label: 'GAME: News', cat: 'gaming', type: 'web', tag: null }, 'GAME_EWC': { label: 'GAME: Video', cat: 'gaming', type: 'video', tag: null }, 'TOPIC_TECH': { label: 'TOPIC: Tech', cat: 'tech', type: 'web', tag: null }, 'TOPIC_ENERGY': { label: 'TOPIC: Energy', cat: 'energy', type: 'web', tag: null }, 'TOPIC_EV': { label: 'TOPIC: EV', cat: 'ev', type: 'web', tag: null }, 'TOPIC_SCI': { label: 'TOPIC: Science', cat: 'science', type: null, tag: null }, 'TOPIC_CONST': { label: 'TOPIC: Constr', cat: 'construction', type: null, tag: null }, 'ECONOMY': { label: 'ECONOMY', cat: 'economy', type: null, tag: null }, 'GEO_EU': { label: 'GEO: EU', cat: 'geopolitics', type: 'video', tag: 'eu' } };

        window.onload = () => { if(localStorage.getItem("gh_token")) { document.getElementById('loginModal').classList.remove('open'); fetchSources(); } };
        function performLogin() {
            localStorage.setItem("gh_user", document.getElementById('userInput').value);
            localStorage.setItem("gh_repo", document.getElementById('repoInput').value);
            localStorage.setItem("gh_token", document.getElementById('tokenInput').value);
            document.getElementById('loginModal').classList.remove('open'); fetchSources();
        }
        function logout() { localStorage.removeItem("gh_token"); location.reload(); }

        async function fetchSources() {
            const u = localStorage.getItem("gh_user"), r = localStorage.getItem("gh_repo"), t = localStorage.getItem("gh_token");
            try {
                // 1. SOURCES
                const res = await fetch(`https://api.github.com/repos/${u}/${r}/contents/sources.py`, { headers: { 'Authorization': `token ${t}` } });
                const d = await res.json(); currentSha = d.sha;
                parsePython(atob(d.content));

                // 2. REAL PREVIEW (news.json)
                try {
                    const res2 = await fetch(`https://api.github.com/repos/${u}/${r}/contents/news.json`, { headers: { 'Authorization': `token ${t}` } });
                    const d2 = await res2.json();
                    const articles = JSON.parse(atob(d2.content));
                    newsMap = {};
                    articles.forEach(a => { if(a.feed_url && a.images?.[0]) newsMap[a.feed_url] = a.images[0]; });
                } catch(e) {}

                renderNav(); renderGrid();
            } catch(e) { alert("Error: " + e.message); }
        }

        function renderGrid() {
            const grid = document.getElementById('grid'); grid.innerHTML = '';
            sourceData[activeFolder].forEach((item, idx) => {
                let imgHtml = '<span>No Preview</span>', tag = '';
                
                // TRUE MATCHING
                const clean = item.url.replace(/\/$/, "");
                const match = newsMap[item.url] || newsMap[clean];
                
                if (match) { 
                    imgHtml = `<img src="${match}">`; 
                    tag = `<div class="live-tag">REAL OUTPUT</div>`; 
                } else if(item.type !== 'video') {
                    // Start simulation if no real output
                    setTimeout(() => loadSim(idx, item.url), 200 + (idx*200));
                }

                const card = document.createElement('div'); card.className = 'card';
                card.innerHTML = `
                    <div class="card-image" id="p-${idx}">${imgHtml}${tag}</div>
                    <input class="edit-name" value="${item.source_name}" onchange="updateItem(${idx}, 'source_name', this.value)">
                    <div style="font-size:0.7rem; color:#666; margin-bottom:5px;">Strategy: ${item.image_strategy || 'Auto'}</div>
                    <div style="display:flex; gap:10px;">
                        <button onclick="analyze('${item.url}', ${idx})" style="background:#222; border:1px solid #444; color:var(--accent);">‚ö° ANALYZE</button>
                        <button onclick="del(${idx})" style="color:red; margin-left:auto;">√ó</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        async function loadSim(idx, url) {
            const div = document.getElementById(`p-${idx}`);
            if(!div || div.innerHTML.includes("REAL")) return;
            div.innerHTML = `<span style="color:#555">Simulating...</span>`;
            try {
                const r = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                const t = await r.text();
                const m = t.match(/(http[s]?:\/\/[^\s"']+\.(?:jpg|jpeg|png|webp))/i);
                if(m) div.innerHTML = `<img src="${m[1]}"><div class="sim-tag">SIMULATION</div>`;
                else div.innerHTML = `<span>No Image Found</span>`;
            } catch(e) { div.innerHTML = `<span>Err</span>`; }
        }

        async function analyze(url, idx) {
            document.getElementById('testerModal').classList.add('open');
            const box = document.getElementById('logicResults'); box.innerHTML = 'Scanning...';
            try {
                const r = await fetch(`https://corsproxy.io/?${encodeURIComponent(url)}`);
                const t = await r.text();
                // Basic extraction logic matching generator
                const m_og = t.match(/property="og:image" content="([^"]+)"/);
                const m_twitter = t.match(/name="twitter:image" content="([^"]+)"/);
                const m_wp = t.match(/class="[^"]*wp-post-image[^"]*" src="([^"]+)"/);
                const m_swec = t.match(/(https:\/\/cdn\.sweclockers\.com\/artikel\/bild\/\d+\?l=[^"'\s>]+)/);
                const m_afton = t.match(/(https:\/\/images\.aftonbladet-cdn\.se\/v2\/images\/[a-zA-Z0-9\-]+)/);
                
                const strats = [
                    {id:'og', name:'OpenGraph', val: m_og?.[1]},
                    {id:'twitter', name:'Twitter', val: m_twitter?.[1]},
                    {id:'wordpress', name:'WordPress', val: m_wp?.[1]},
                    {id:'swec', name:'Sweclockers', val: m_swec?.[0]},
                    {id:'afton', name:'Aftonbladet', val: m_afton?.[0]}
                ];

                box.innerHTML = '';
                strats.forEach(s => {
                    if(s.val) {
                        box.innerHTML += `
                        <div class="logic-item">
                            <img src="${s.val}" class="logic-preview">
                            <div style="flex:1"><b>${s.name}</b><br><small>${s.val.substring(0,30)}...</small></div>
                            <button class="btn-apply" onclick="setStrat(${idx}, '${s.id}')">USE THIS</button>
                        </div>`;
                    }
                });
                if(!box.innerHTML) box.innerHTML = '<p>No images found via proxy.</p>';
            } catch(e) { box.innerHTML = 'Error fetching url.'; }
        }

        function setStrat(idx, strat) {
            sourceData[activeFolder][idx].image_strategy = strat;
            document.getElementById('testerModal').classList.remove('open');
            alert("Strategy saved! Click SAVE ALL to persist.");
        }

        // --- STANDARD HELPERS ---
        function parsePython(text) {
            const start = text.indexOf('SOURCES = ['); const end = text.indexOf('URLS_GLOBAL = [');
            let content = text.substring(start, end).replace('SOURCES = [', '').trim();
            if(content.endsWith(']')) content = content.slice(0, -1);
            for(let k in FOLDER_CONFIG) sourceData[k] = [];
            content.split('\n').forEach(line => {
                line = line.trim(); if(!line.startsWith('{')) return;
                if(line.endsWith(',')) line = line.slice(0, -1);
                try {
                    const item = JSON.parse(line);
                    for(let id in FOLDER_CONFIG) {
                        if(item.cat === FOLDER_CONFIG[id].cat && item.filter_tag === FOLDER_CONFIG[id].tag) {
                            sourceData[id].push(item); break;
                        }
                    }
                } catch(e){}
            });
        }
        function renderNav() {
            const nav = document.getElementById('navBar'); nav.innerHTML = '';
            for(let id in FOLDER_CONFIG) {
                const btn = document.createElement('div'); btn.className = `nav-item ${activeFolder===id?'active':''}`;
                btn.innerText = FOLDER_CONFIG[id].label; btn.onclick=()=>{activeFolder=id;renderGrid();}; nav.appendChild(btn);
            }
        }
        async function saveToGitHubSafe() {
            if(!confirm("Push to GitHub?")) return;
            let py = "SOURCES = [\n";
            for(let k in sourceData) sourceData[k].forEach(i => py += `    ${JSON.stringify(i)},\n`);
            py += "]\n\nURLS_GLOBAL = []";
            const u=localStorage.getItem("gh_user"), r=localStorage.getItem("gh_repo"), t=localStorage.getItem("gh_token");
            await fetch(`https://api.github.com/repos/${u}/${r}/contents/sources.py`, {
                method: 'PUT', headers: { 'Authorization': `token ${t}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: "Update", content: btoa(py), sha: currentSha })
            });
            alert("Saved!");
        }
        async function deploy() {
             const u=localStorage.getItem("gh_user"), r=localStorage.getItem("gh_repo"), t=localStorage.getItem("gh_token");
             await fetch(`https://api.github.com/repos/${u}/${r}/actions/workflows/main.yml/dispatches`, {
                method: 'POST', headers: { 'Authorization': `token ${t}`, 'Accept': 'application/vnd.github.v3+json' },
                body: JSON.stringify({ ref: 'main' })
            });
            alert("Deploy started!");
        }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        function openDumpModal() { document.getElementById('dumpModal').classList.add('open'); }
        function openSelector(t) { /* Implement selectors */ }
        function handleFileDump(f) { /* Implement dump */ }
        function updateItem(idx, f, v) { sourceData[activeFolder][idx][f] = v; }
        function del(idx) { if(confirm("Delete?")) { sourceData[activeFolder].splice(idx, 1); renderGrid(); } }
    </script>
</body>
</html>